# åˆ†å¸ƒå¼é‚»å±…åˆ—è¡¨æŸ¥è¯¢ç³»ç»Ÿ (Distributed-NL)

è¿™æ˜¯ä¸€ä¸ªåŸºäºMPCçš„åˆ†å¸ƒå¼é‚»å±…åˆ—è¡¨æ£€ç´¢ç³»ç»Ÿï¼Œä¸“é—¨ç”¨äºå®‰å…¨åœ°æŸ¥è¯¢å‘é‡çš„Kæœ€è¿‘é‚»å±…ç´¢å¼•ã€‚

## ç³»ç»Ÿæ¶æ„

### ä¸distributed-deployçš„åŒºåˆ«

| ç‰¹æ€§ | distributed-deploy | distributed-nl |
|------|-------------------|----------------|
| **åŠŸèƒ½** | æŸ¥è¯¢å‘é‡å†…å®¹ | æŸ¥è¯¢é‚»å±…åˆ—è¡¨ |
| **è¾“å…¥** | èŠ‚ç‚¹ç´¢å¼• | æŸ¥è¯¢èŠ‚ç‚¹ç´¢å¼• |
| **è¾“å‡º** | å®Œæ•´å‘é‡å€¼ | Kä¸ªé‚»å±…ç´¢å¼• |
| **ç«¯å£** | 8001-8003 | 9001-9003 |
| **æ•°æ®** | nodes_shares.npy | neighbors_shares.npy |

## ç½‘ç»œé…ç½®

- **å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨**: ä½¿ç”¨å…¬ç½‘IPé€šä¿¡
  - Server1: `192.168.1.101:9001`
  - Server2: `192.168.1.102:9002`
  - Server3: `192.168.1.103:9003`

- **æœåŠ¡å™¨ â†” æœåŠ¡å™¨**: ä½¿ç”¨ç§ç½‘IPé€šä¿¡
  - Server1: `10.0.1.101:9001`
  - Server2: `10.0.1.102:9002`
  - Server3: `10.0.1.103:9003`

## å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨æœåŠ¡å™¨

åœ¨æ¯å°æœåŠ¡å™¨ä¸Šè¿è¡Œï¼š

```bash
# æœåŠ¡å™¨1
python server.py --server-id 1 --dataset siftsmall --vdpf-processes 4

# æœåŠ¡å™¨2
python server.py --server-id 2 --dataset siftsmall --vdpf-processes 4

# æœåŠ¡å™¨3
python server.py --server-id 3 --dataset siftsmall --vdpf-processes 4
```

### 2. è¿è¡Œå®¢æˆ·ç«¯æµ‹è¯•

```bash
# åŸºæœ¬æµ‹è¯•
python client.py --dataset siftsmall --num-queries 10

# æµ‹è¯•å…¶ä»–æ•°æ®é›†
python client.py --dataset laion --num-queries 5

# åªæŸ¥çœ‹æœåŠ¡å™¨çŠ¶æ€
python client.py --status-only
```

## éƒ¨ç½²è„šæœ¬

### åŒæ­¥åˆ°æ‰€æœ‰æœåŠ¡å™¨

```bash
./deploy.sh
```

### åœ¨æ‰€æœ‰æœåŠ¡å™¨ä¸Šå¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨æ‰€æœ‰é‚»å±…åˆ—è¡¨æœåŠ¡å™¨
./start-servers.sh

# åœæ­¢æ‰€æœ‰æœåŠ¡å™¨
./stop-servers.sh
```

## æ€§èƒ½ä¼˜åŒ–

### 1. TCPå‚æ•°ä¼˜åŒ–ï¼ˆåœ¨æ‰€æœ‰æœåŠ¡å™¨æ‰§è¡Œï¼‰

```bash
sudo sysctl -w net.core.rmem_max=268435456
sudo sysctl -w net.core.wmem_max=268435456
sudo sysctl -w net.ipv4.tcp_rmem="4096 87380 268435456"
sudo sysctl -w net.ipv4.tcp_wmem="4096 65536 268435456"
```

### 2. è¿›ç¨‹æ•°ä¼˜åŒ–

æ ¹æ®CPUæ ¸å¿ƒæ•°è°ƒæ•´ï¼š
```bash
python server.py --server-id 1 --vdpf-processes 32  # å¯¹äº64æ ¸æœºå™¨
```

## æ•°æ®é›†æ”¯æŒ

| æ•°æ®é›† | é‚»å±…æ•°(K) | èŠ‚ç‚¹æ•° | çŠ¶æ€ |
|--------|-----------|--------|------|
| siftsmall | 100 | 10,000 | âœ… å®Œå…¨æ”¯æŒ |
| laion | 36 | 100,000 | âœ… å®Œå…¨æ”¯æŒ |
| nfcorpus | 10 | 3,633 | âœ… å®Œå…¨æ”¯æŒ |
| tripclick | 36 | 1.5M | ğŸŸ¡ éœ€è¦æ•°æ®å‡†å¤‡ |

## ç›‘æ§åŠŸèƒ½

ç³»ç»Ÿä¼šè‡ªåŠ¨è®°å½•å¹¶æ˜¾ç¤ºï¼š
- æ¯ä¸ªé˜¶æ®µçš„æ‰§è¡Œæ—¶é—´
- ç½‘ç»œä¼ è¾“å¤§å°å’Œé€Ÿåº¦
- é‚»å±…åˆ—è¡¨æŸ¥è¯¢å‡†ç¡®ç‡
- è¯¦ç»†çš„æ€§èƒ½ç»Ÿè®¡

## æµ‹è¯•æŠ¥å‘Š

æµ‹è¯•ç»“æœä¼šè‡ªåŠ¨ä¿å­˜åˆ° `nl_result.md`ï¼ŒåŒ…å«ï¼š
- è¯¦ç»†çš„æŸ¥è¯¢æ—¶é—´åˆ†è§£
- ç½‘ç»œä¼ è¾“ç»Ÿè®¡
- å‡†ç¡®ç‡è¯„ä¼°
- æ€§èƒ½åˆ†æ

## æ•…éšœæ’é™¤

### è¿æ¥å¤±è´¥
- æ£€æŸ¥å®‰å…¨ç»„è§„åˆ™æ˜¯å¦å¼€æ”¾9001-9003ç«¯å£
- ç¡®è®¤æœåŠ¡å™¨æ­£åœ¨ç›‘å¬æ­£ç¡®çš„ç«¯å£
- éªŒè¯ç½‘ç»œè¿é€šæ€§

### æ•°æ®ä¸å®Œæ•´é”™è¯¯
- ç³»ç»Ÿå·²ä½¿ç”¨MSG_WAITALLä¼˜åŒ–ï¼Œåº”è¯¥ä¸ä¼šå‡ºç°æ­¤é—®é¢˜
- å¦‚ä»æœ‰é—®é¢˜ï¼Œæ£€æŸ¥ç½‘ç»œç¨³å®šæ€§

### å‡†ç¡®ç‡é—®é¢˜
- ç¡®ä¿neighbors_shares.npyæ•°æ®æ­£ç¡®ç”Ÿæˆ
- éªŒè¯groundtruthæ•°æ®æ ¼å¼åŒ¹é…

## é«˜çº§åŠŸèƒ½

### è‡ªå®šä¹‰æœåŠ¡å™¨é…ç½®

åˆ›å»º `custom_servers.json`:
```json
{
  "1": {"host": "192.168.1.101", "port": 9001},
  "2": {"host": "192.168.1.102", "port": 9002},
  "3": {"host": "192.168.1.103", "port": 9003}
}
```

ä½¿ç”¨è‡ªå®šä¹‰é…ç½®ï¼š
```bash
python client.py --config custom_servers.json
```

## ä¸å‘é‡æŸ¥è¯¢ç³»ç»Ÿé›†æˆ

å®Œæ•´çš„å‘é‡æœç´¢æµç¨‹ï¼š
1. ä½¿ç”¨ `distributed-nl` æŸ¥è¯¢Kä¸ªæœ€è¿‘é‚»å±…ç´¢å¼•
2. ä½¿ç”¨ `distributed-deploy` æ£€ç´¢è¿™äº›é‚»å±…çš„å‘é‡å†…å®¹
3. åœ¨å®¢æˆ·ç«¯è®¡ç®—ç²¾ç¡®ç›¸ä¼¼åº¦å¹¶æ’åº

è¿™ç§åˆ†ç¦»è®¾è®¡æä¾›äº†æ›´å¥½çš„çµæ´»æ€§å’Œæ€§èƒ½ä¼˜åŒ–ç©ºé—´ã€‚